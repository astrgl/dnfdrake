' Gambas class file

Public $mod As Boolean
Public Sub Form_Open()
  Dim s As String
  Dim t As Stream
  Dim p As Integer
  Dim EXCL As String[]
  Dim i As String
  FTEMPPKGLIST.Text = Fmain.TXTPKGLISTNOME.Text
  
  'TITOLI E TOOTIP*******************************************************************
    Dim flTTP As File  
    Dim jTTP As Byte
    Dim s$TTP As String
    Dim ss$TTP As New String[]
    
    Fmain.Btnclear_click
    $mod = False
    flTTP = Open "/usr/share/dnfdrake/dnfdrake-TTP-" & Fmain.$LANG For Read   ' ...oppure "Input"  
    While Not Eof(flTTP)
      Input #flTTP, s$TTP
      ss$TTP.Add(s$TTP)
     Wend
     Close #flTTP
     For jTTP = 0 To ss$TTP.Max
   
         BTNREMOVE.Tooltip = Replace(ss$TTP[61], "_", " ") 
         BTNREFRESH.Tooltip = Replace(ss$TTP[62], "_", " ") 
         BTNSAVEAS.Tooltip = Replace(ss$TTP[63], "_", " ") 
         BTNCLOSE.Tooltip = Replace(ss$TTP[4], "_", " ") 
         LTITOLO.Text = Replace(ss$TTP[64], "_", " ") 
     Next
     flTTP.Close
     BTNREMOVE.Picture = Picture.Load(FMAIN.$PATHICONS & "remove" & FMain.$THEMESSUFFIX)
     BTNREFRESH.Picture = Picture.Load(FMAIN.$PATHICONS & "refresh" & FMain.$THEMESSUFFIX)
     BTNSAVEAS.Picture = Picture.Load(FMAIN.$PATHICONS & "save-as" & FMain.$THEMESSUFFIX)
     BTNCLOSE.Picture = Picture.Load(FMAIN.$PATHICONS & "close" & FMain.$THEMESSUFFIX)
 '*********************************************************************************
  Me.Mouse = Mouse.Wait  
    t = Open "/etc/dnf/dnf.conf"
      For Each s In t.Lines
        If InStr(s, "exclude") Then
          EXCL = Split(s, " ")
            For Each i In EXCL
              If i <> "exclude=" And If i <> "exclude" And If i <> "="
                 p = p + LSTPKG.Count
                 LSTPKG.add(p, i)
              Endif
            Next 
        Endif
      Next 
 If Fmain.$SECUREMODE = "SECURE" Then
    Fmain.Enabled = False 
 Endif
 Me.Mouse = Mouse.Default
End
Public Sub Form_Close()
  Fmain.Enabled = True
  Fmain.Btnclear_click
End

Public Sub BTNCLOSE_Click()
  If $mod = True Then
     Fmain.TimerUPLISTE.Enabled = True
  Endif
  BTNCLOSE.Enabled = False
  Me.Close
End


Public Sub BTNREMOVE_Click()
  Dim a As String
  Dim s As String
    Me.Mouse = Mouse.Wait  
    $mod = True
    If LSTPKG.Selection.Count = LSTPKG.Count Then
      LSTPKG.UnSelectAll
      LSTPKG.Clear
      Print #Fmain.$hProcess, "sudo sed -i '/exclude/d' /etc/dnf/dnf.conf " & gb.NewLine;
    Else     
      For Each a In LSTPKG.Selection
      s = s & " " & LSTPKG[a].Text  
      LSTPKG[a].Delete
      Next
        Print #Fmain.$hProcess, "sudo " & "sed -i 's/" & s & "//g' " & " /etc/dnf/dnf.conf " & gb.NewLine; 
        'TextBox1.Text = "sudo " & "sed -i 's/" & s & "//g' " & " /etc/dnf/dnf.conf "
    Endif
     Wait 0.1
     Fmain.Enabled = True
     Fmain.Btnclear_click
     Fmain.Enabled = False
     Me.Mouse = Mouse.Default  
End

Public Sub BTNSAVEAS_Click()
  Dim i As String
  
  Dialog.Path = Fmain.$pathdir                   'IMPOSTA LA FINESTRA IN CUI SALVARE LA LISTA
  Dialog.Filter = ["*.txt", "Text Files"]
    If Dialog.SaveFile() Then Return
      Fmain.$pathdir = Replace(Dialog.Path, " ", Chr$(92) & " ")  ' serve agestire percorsi con gli spazi
      'Print #Fmain.$hProcess, "echo > " & Dialog.Path & gb.NewLine; 
      LSTPKG.SelectAll
      For Each i In LSTPKG.Selection
        Print #Fmain.$hProcess, "echo " & LSTPKG[i].Text & " >>  " & Dialog.Path & gb.NewLine; 
      Next 
      
      BTNREFRESH_Click
      Wait 0.2
      Fmain.Enabled = True
      Fmain.Btnclear_click
      Fmain.Enabled = False
End


Public Sub LTITOLO_MouseDown()
End
Public Sub BTNREFRESH_Click()

  Dim s As String
  Dim t As Stream
  Dim p As Integer
  Dim EXCL As String[] 
  Dim i As String
    Me.Mouse = Mouse.Wait  
    LSTPKG.UnSelectAll
    LSTPKG.Clear
     t = Open "/etc/dnf/dnf.conf"
      For Each s In t.Lines
        If InStr(s, "exclude") Then
          EXCL = Split(s, " ")
            For Each i In EXCL
              If i <> "exclude=" And If i <> "exclude" And If i <> "="
                 p = p + LSTPKG.Count
                 LSTPKG.add(p, i)
              Endif
            Next 
        Endif
      Next 
 Me.Mouse = Mouse.Default  

End
