' Gambas class file

' Gambas class file
'variabili di sistema
 Public $SI As String
 Public $NO As String
 'Public $ASK As String
 Public $SECURE As Integer
 Public $SEDWORD As String
 Public $INIZIOTAGLIO As String
 
Public Sub Form_Open()
 'pulsanti
 Dim flBTN As File  
 Dim jBTN As Byte
 Dim s$BTN As String
 Dim ss$BTN As New String[]
 'testi e tooltip
 Dim flTTP As File  
 Dim jTTP As Byte
 Dim s$TTP As String
 Dim ss$TTP As New String[]
 'parole chiave
 Dim flKEY As File  
 Dim jKEY As Byte
 Dim s$KEY As String
 Dim ss$KEY As New String[]
 
'RIDIMENSIONAMENTO FINESTRA************************
 If Fmain.Width > 1366 Then
  FSINOSECURE.Width = FSINOSECURE.Width * (Fmain.$RISOLUZIONEX / 1366)
  FSINOSECURE.Height = FSINOSECURE.Height * (Fmain.$RISOLUZIONEY / 786)
  TextArea1.Width = TextArea1.Width * (Fmain.$RISOLUZIONEX / 1366)
  TextArea1.Height = TextArea1.Height * (Fmain.$RISOLUZIONEY / 786)
  BTNSI.Y = BTNSI.Y + (FSINOSECURE.Height - 553)
  BTNNO.X = BTNNO.X + (FSINOSECURE.Width - 1148)
  BTNNO.Y = BTNNO.Y + (FSINOSECURE.Height - 553)
  LBLASK.Y = LBLASK.Y + (FSINOSECURE.Height - 553)
  LBLASK.X = LBLASK.X + ((FSINOSECURE.Width - 1148) / 2) 
Endif
'**************************************************
 flBTN = Open "/usr/share/dnfdrake/dnfdrake-BTN-" & Fmain.$LANG For Read   ' ...oppure "Input"
 While Not Eof(flBTN)
   Input #flBTN, s$BTN
   ss$BTN.Add(s$BTN)
  Wend
   Close #flBTN
  For jBTN = 0 To ss$BTN.Max
     BTNSI.Text = ss$BTN[16]
     BTNNO.Text = ss$BTN[17]
     Next
   flBTN.Close      
   
'TITOLI E TOOTIP*******************************************************************
  flTTP = Open "/usr/share/dnfdrake/dnfdrake-TTP-" & Fmain.$LANG For Read   ' ...oppure "Input"
 While Not Eof(flTTP)
   Input #flTTP, s$TTP
   ss$TTP.Add(s$TTP)
  Wend
   Close #flTTP
  For jTTP = 0 To ss$TTP.Max
      FSINO.Text = Replace(ss$TTP[23], "_", " ")
      LBLASK.Text = Replace(ss$TTP[101], "_", " ")
       Next
   flTTP.Close  
   
'PAROLE CHIAVE*******************************************************************
    'MODIFICA PER DNF5flKEY = Open "/usr/share/dnfdrake/dnfdrake-KEY-" & Fmain.$LANG For Read   ' ...oppure "Input"
 ' If Fmain.$DNFVERSION = "DNF5" Then
 '  flKEY = Open "/usr/share/dnfdrake/dnfdrake-KEY5-" & Fmain.$LANG For Read   ' ...oppure "Input"
 ' Else 
 '  flKEY = Open "/usr/share/dnfdrake/dnfdrake-KEY-" & Fmain.$LANG For Read   ' ...oppure "Input"
 ' Endif 
 
 If Fmain.$DNFVERSIONNUMBER > 50213 Then
  flKEY = Open "/usr/share/dnfdrake/dnfdrake-KEY5_14-" & Fmain.$LANG For Read   ' ...oppure "Input"
Else If Fmain.$DNFVERSIONNUMBER > 50000 Then 
    flKEY = Open "/usr/share/dnfdrake/dnfdrake-KEY5-" & Fmain.$LANG For Read
Else   
    flKEY = Open "/usr/share/dnfdrake/dnfdrake-KEY-" & Fmain.$LANG For Read   ' ...oppure "Input"
Endif
 
 While Not Eof(flKEY)
   Input #flKEY, s$KEY
   ss$KEY.Add(s$KEY)
  Wend
   Close #flKEY
  For jKEY = 0 To ss$KEY.Max
    
    '$ASK = Replace(ss$KEY[2], "_", " ") & "?"
'risposta si
      $SI = Replace(ss$KEY[5], "_", " ")
'risposta no
      $NO = Replace(ss$KEY[6], "_", " ")
' PAROLA CHIAVE PER SED
   If Fmain.$DNFVERSIONNUMBER > 50000 Then
      $SEDWORD = Replace(ss$KEY[9], "_", " ")         
      $INIZIOTAGLIO = Replace(ss$KEY[10], "_", " ")
      ' Print $SEDWORD
   Endif
    Next
   flKEY.Close
 '*********************************************************************************
 If FRUN.Visible = True Then
   FRUN.$CLOSEPASS = 1
   FRUN.Close
 Endif
 If FERROR.Visible = True Then
   FERROR.Close
 Endif
 Fmain.Enabled = False
 BTNSI.Enabled = False
 BTNNO.Enabled = False
 Timer1.Enabled = True
 $SECURE = 0
 
 '***************************IN TEST*********************************************************
  ' If Exist(User.Home & "/.config/dnfdrake/log/trashfile.log") Then
  '    Shell "rm -f " & User.Home & "/.config/dnfdrake/log/trashfile.log" Wait 
  ' Endif
  ' 
  If Fmain.$COLORTEXTCONSOLE = "Default" Then
      TextArea1.Foreground = Color.Default
    Else If Fmain.$COLORTEXTCONSOLE = "Green" Then
      TextArea1.Foreground = Color.Green
    Else If Fmain.$COLORTEXTCONSOLE = "Red" Then
      TextArea1.Foreground = Color.Red
    Else If Fmain.$COLORTEXTCONSOLE = "Blue" Then
      TextArea1.Foreground = Color.Blue
    Endif
 
End

Public Sub BTNSI_Click()
 BTNSI.Enabled = False
 Print #Fmain.$hProcess, $SI & gb.NewLine;
 If Fmain.$SECUREMODE = "SECURE" Then
  FRUN.Show 
 Endif
 $SECURE = 1 
 Me.Close  

End

Public Sub BTNNO_Click()
BTNNO.Enabled = False
If $SECURE = 0 Then
  Print #Fmain.$hProcess, $NO & gb.NewLine; 
  Wait 0.5
  Fmain.Btnclear_click
  Fmain.Mouse = Mouse.Default
  Fmain.TMPLISTCLEAN
  Fmain.Enabled = True
  $SECURE = 1 
  Me.Close  
Endif
  
End

Public Sub Form_Close()
If $SECURE = 1 Then
Else 
  BTNNO_Click
Endif
If Fmain.$AUTOSUSPEND = 1 Then
  Fmain.$CLEARLOGSUSPEND = 1  
Endif

End

Public Sub TextArea1_KeyPress()
End

Public Sub FIXTPMLOG()
  Dim sLastLine As String
  Dim $GREPCOMMAND As String
  
' tail -n 1 estrae solo l'ultima riga istantaneamente
  Shell "tail -n 1 " & User.Home & "/.config/dnfdrake/log/tmp.log " To sLastLine
  If InStr(sLastLine, Fmain.$PROCEDERE) > 0 Then 
    'Print "NO-FIX"
  Else 
    'Print "FIX"
    ' #1. Estrai la parte che ti interessa
    ' #(Print s)permette al punto.di includere i ritorni a capo
    'grep -zoP "(?s)Total.*?\[y/N\]:" tmp.log > blocco.txt
    Shell "grep -zoP " & Chr(34) & "(?s)" & $INIZIOTAGLIO & ".*?" & Chr(92) & "[y/N" & Chr(92) & "]:" & Chr(34) & "  " & User.Home & "/.config/dnfdrake/log/tmp.log > " & User.Home & "/.config/dnfdrake/log/FIXtmp.log " Wait 
    ' #2. Rimuovi la parte originale dal file
    ' #Nota: assicurati che il pattern corrisponda esattamente(spazi inclusi)
    'sed -z -i 's/Total.*\[y\/N\]://' tmp.log
    'sed -z -i 's/Total.*\]://' tmp.log
     Shell "sed -z -i 's/" & $INIZIOTAGLIO & ".*" & Chr(92) & "]://'" & " " & User.Home & "/.config/dnfdrake/log/tmp.log" Wait
    '#3.Aggiungi il blocco In fondo e rimuovi il temporaneo
    '#Usiamo tr - d '\0' per eliminare il carattere null aggiunto da grep -z
    'tr -d '\0' < blocco.txt >> tmp.log && rm blocco.txt
    Shell "tr -d '" & Chr(92) & "0' < " & User.Home & "/.config/dnfdrake/log/FIXtmp.log >> " & User.Home & "/.config/dnfdrake/log/tmp.log && rm " & User.Home & "/.config/dnfdrake/log/FIXtmp.log" Wait 
    Endif
  
End




Public Sub LOADTEXT()
  Me.Mouse = Mouse.Wait
  
  If Fmain.$DNFVERSIONNUMBER > 50000 Then
     FIXTPMLOG
     Shell "cat " & Fmain.$FILETMPLOG & " | sed -n '/" & $SEDWORD & "/,/*/p'" To TextArea1.Text
  Else 
     Shell "cat " & Fmain.$FILETMPLOG & " | sed -n '/=/,/*/p'" To TextArea1.Text  
  Endif 
  
  Me.Mouse = Mouse.Default
  BTNSI.Enabled = True
  BTNNO.Enabled = True
  BTNSI.SetFocus

End

Public Sub Timer1_Timer()

     LOADTEXT    
     Timer1.Enabled = False

End
